Filename: AreaByHeightSide.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include <string.h>

#include "module/iam/core/iam.h"
#include "AreaByHeightSide.h"

static double sideArea(void *self, const AreaBySideHeight_Adapter *fn)
{
  return 0.5 * fn->getSide(self) * fn->getHeight(self);
}

static double sideArea2(void *self, const AreaBySideHeight_Adapter *fn)
{
  return AreaBySideHeight_fn.sideArea(self, fn) / 2;
}

AreaBySideHeight_Fn AreaBySideHeight_fn;

/* Mixin initializer */
void AreaBySideHeight_prototype(void)
{
  AreaBySideHeight_fn.sideArea = sideArea;
  AreaBySideHeight_fn.sideArea2 = sideArea2;
}



Filename: AreaByHeightSide.h
----------------------------------------
#ifndef AREA_BY_SIDE_HEIGHT_H
#define AREA_BY_SIDE_HEIGHT_H

#include "module/iam/core/iam.h"

void AreaBySideHeight_prototype(void);

__attribute__((constructor)) static void register_AreaBySideHeight(void)
{
  iam_register(AreaBySideHeight_prototype);
}

#define AREA_BY_SIDE_HEIGHT_ADAPTER_METHOD_LIST \
  METHOD(double, getHeight)        \
  METHOD(double, getSide)       

#define AREA_BY_SIDE_HEIGHT_METHOD_LIST \
  METHOD(double, sideArea, const AreaBySideHeight_Adapter *fn)     \
  METHOD(double, sideArea2, const AreaBySideHeight_Adapter *fn)       

/* Child struct */
typedef struct AreaBySideHeight_Adapter
{
#define METHOD(ret, name, ...) ret (*name)(void*, ##__VA_ARGS__);
    AREA_BY_SIDE_HEIGHT_ADAPTER_METHOD_LIST
#undef METHOD
} AreaBySideHeight_Adapter;

/* AreaBySideHeight vtable */
typedef struct AreaBySideHeight_Fn
{
#define METHOD(ret, name, ...) ret (*name)(void*, ##__VA_ARGS__);
    AREA_BY_SIDE_HEIGHT_METHOD_LIST
#undef METHOD
} AreaBySideHeight_Fn;

extern AreaBySideHeight_Fn AreaBySideHeight_fn;

#endif


Filename: iam.c
----------------------------------------
// iam.c
#include "module/iam/core/iam.h"

static InitFn registry[2048];
static size_t registry_count = 0;

void iam_register(InitFn fn) {
    registry[registry_count++] = fn;
}

void iam_boot(void) {
    for (size_t i = 0; i < registry_count; i++)
        registry[i]();
}



Filename: iam.h
----------------------------------------
#ifndef IAM_H
#define IAM_H

#include <stdlib.h>

typedef void (*InitFn)(void);

void iam_register(InitFn fn);
void iam_boot(void);

/* Allocate */
#define NEW(T) (T*)malloc(sizeof(T))
    
#define INHERIT_METHODS_FROM(parent_fn, child_fn) \
    memcpy(&(child_fn), &(parent_fn), sizeof(parent_fn));

#endif


Filename: main.c
----------------------------------------
#include <stdio.h>

#include "Shape.h"
#include "Rectangle.h"
#include "Triangle.h"

int main()
{
    iam_boot();
    Triangle *t = Triangle_new();
    t->w = 10;
    t->h = 51;
    t->sideLength = 6;
    t->multiplier = 3;

    t->fn->describe(t);
    t->fn->parentMethod(t, 42.0);

    printf("----\n");
    Shape *s = Shape_new();
    s->w = 4;
    s->h = 3;

    s->fn->describe(s);

    // printf("----\n");
    // Rectangle *r = Rectangle_new();
    // r->w = 10;
    // r->h = 5;
    // r->multiplier = 5;

    // r->fn->describe(r);
    // printf("[Rectangle] perimeter=%.2f\n", r->fn->perimeter(r));
    // printf("[Rectangle] area=%.2f\n", r->fn->area(r));

    printf("----\n");

    Triangle *t2 = Triangle_new();
    t2->w = 3;
    t2->h = 3;
    t2->sideLength = 6;
    t2->multiplier = 3;

    t2->fn->describe(t2);
    return 0;
}


Filename: Rectangle.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include <string.h>

#include "module/iam/core/iam.h"

#include "Shape.h"
#include "Rectangle.h"

/* === PRIVATE METHODS === */

static double _privateMethod(Rectangle *r)
{
  return r->w * r->h * r->multiplier * 42;
}

/* === PUBLIC METHODS === */

static double area(Rectangle *r)
{
  printf("[Rectangle.area] called\n");
  double base = Shape_fn.area((Shape *)r);
  printf("[Rectangle.area] base=%.2f\n", base);
  return base * r->multiplier * 3 * r->fn->_privateMethod(r);
}

static double scaledArea(Rectangle *r)
{
  return r->w * r->h * r->multiplier;
}

static double diagonal(Rectangle *r)
{
  return sqrt(r->w * r->w + r->h * r->h);
}

static void describe(Rectangle *r)
{
  printf("[Rectangle] scaled=%.2f diag=%.2f\n",
         scaledArea(r),
         diagonal(r));
}

static void parentMethod(Rectangle *r, double x)
{
  printf("[Rectangle.parentMethod] called with x=%.2f\n", x);
}

Rectangle_Fn Rectangle_fn;

#define Rectangle_PRIVATE_METHODS \
  X(_privateMethod)

#define Rectangle_PUBLIC_METHODS \
  /* Core geometry */            \
  X(area)                        \
  X(describe)                    \
  X(scaledArea)                  \
  X(diagonal)                    \
  X(parentMethod)

#define Rectangle_IMPLEMENTED_METHODS \
  Rectangle_PRIVATE_METHODS           \
  Rectangle_PUBLIC_METHODS

/* class initializer */
void Rectangle_prototype(void)
{
  INHERIT_METHODS_FROM(Shape_fn, Rectangle_fn); // auto copy

#define X(name) Rectangle_fn.name = name;
  Rectangle_IMPLEMENTED_METHODS
#undef X
}

/* ctor */
Rectangle *Rectangle_new()
{
  Rectangle *r = NEW(Rectangle);
  r->fn = &Rectangle_fn;

  return r;
}


Filename: Rectangle.h
----------------------------------------
#ifndef Rectangle_H
#define Rectangle_H

#include "module/iam/core/iam.h"
#include "Shape.h"

void Rectangle_prototype(void);

__attribute__((constructor)) static void register_Rectangle(void)
{
  iam_register(Rectangle_prototype);
}

#define Rectangle_ONLY_FIELD_LIST \
  X(multiplier, double)
#define Rectangle_FIELD_LIST \
  Shape_FIELD_LIST           \
  Rectangle_ONLY_FIELD_LIST

#define Rectangle_ONLY_METHOD_LIST \
  METHOD(double, _privateMethod)   \
  METHOD(double, scaledArea)       \
  METHOD(double, diagonal)         \
  METHOD(void, parentMethod, double)
#define Rectangle_METHOD_LIST \
  Shape_METHOD_LIST           \
  Rectangle_ONLY_METHOD_LIST

/* Child struct */
typedef struct Rectangle
{
  struct Rectangle_Fn *fn; /* own vtable */
#define X(name, type) type name;
  Rectangle_FIELD_LIST
#undef X
} Rectangle;

/* Rectangle vtable */
typedef struct Rectangle_Fn
{
#define METHOD(ret, name, ...) ret (*name)(Rectangle *, ##__VA_ARGS__);
  Rectangle_METHOD_LIST
#undef METHOD
} Rectangle_Fn;

extern Rectangle_Fn Rectangle_fn;

Rectangle *Rectangle_new();

#endif


Filename: Shape.c
----------------------------------------
#include <stdio.h>
#include "Shape.h"

/* ---- implementations ---- */

static double area(Shape *s)
{
  double base = s->w * s->h * 3;
  printf("[Shape.area] w=%.2f h=%.2f base=%.2f\n", s->w, s->h, base);
  return base;
}

static double perimeter(Shape *s)
{
  return 2 * (s->w + s->h);
}

static void describe(Shape *s)
{
  printf("[Shape] w=%.2f h=%.2f area=%.2f\n",
         s->w, s->h, area(s));
}

Shape_Fn Shape_fn;

#define Shape_PUBLIC_METHODS \
  /* Core geometry */        \
  X(area)                    \
  X(describe)                \
  X(perimeter)

#define Shape_IMPLEMENTED_METHODS \
  Shape_PUBLIC_METHODS

/* Class prototype */
void Shape_prototype(void)
{
#define X(name) Shape_fn.name = name;
  Shape_IMPLEMENTED_METHODS
#undef X
}

Shape *Shape_new()
{
  Shape *s = NEW(Shape);
  s->fn = &Shape_fn;

  return s;
}


Filename: Shape.h
----------------------------------------
#ifndef Shape_H
#define Shape_H

#include "module/iam/core/iam.h"

void Shape_prototype(void);

__attribute__((constructor)) static void register_Shape(void)
{
  iam_register(Shape_prototype);
}

/* X-macro field lists */
#define Shape_FIELD_LIST \
  X(w, double)           \
  X(h, double)

/* X-macro method lists */
#define Shape_METHOD_LIST   \
  METHOD(double, area)      \
  METHOD(double, perimeter) \
  METHOD(void, describe)

/* Generate struct */
typedef struct Shape
{
  struct Shape_Fn *fn;
/* fields */
#define X(name, type) type name;
  Shape_FIELD_LIST
#undef X
} Shape;

/* vtable */
typedef struct Shape_Fn
{
#define METHOD(ret, name, ...) ret (*name)(Shape*, ##__VA_ARGS__);
    Shape_METHOD_LIST
#undef METHOD
} Shape_Fn;

extern Shape_Fn Shape_fn;

/* ctor */
Shape *Shape_new();

#endif



Filename: Triangle.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include <string.h>

#include "module/iam/core/iam.h"
#include "AreaByHeightSide.h"
#include "Rectangle.h"
#include "Triangle.h"

/* === PRIVATE METHODS === */

static double _calculateComplex(Triangle *r)
{
    return r->w * r->multiplier + r->fn->diagonal(r) * r->w;
}

static double _calculateAreaIntense(Triangle *r)
{
    return r->h * r->multiplier + r->fn->diagonal(r) * 5;
}

static double _calculateAreaAlt(Triangle *r)
{
    return r->h * r->multiplier + r->fn->diagonal(r);
}

/* === PUBLIC METHODS === */

static double area(Triangle *r)
{
    Rectangle_fn.parentMethod((Rectangle *)r, 3.14);
    /* 'super' is stored as void* in the fn table; cast it to Rectangle_Fn* to access area */
    printf("[Triangle.area] called\n");
    double base = Rectangle_fn.area((Rectangle *)r);
    printf("[Triangle.area] base=%.2f\n", base);
    return base * r->multiplier * 2 * r->fn->diagonal(r) * r->fn->_calculateComplex(r);
}

static double scaledArea(Triangle *r)
{
    return r->w * r->h * r->multiplier;
}

static double diagonal(Triangle *r)
{
    return sqrt(r->w * r->w + r->h * r->h);
}

static double sideArea(Triangle *r)
{
    return AreaBySideHeight_fn.sideArea(r, &r->fn->AreaBySideHeight);
}

static double sideArea2(Triangle *r)
{
    return AreaBySideHeight_fn.sideArea2(r, &r->fn->AreaBySideHeight);
}

static double rightAngle(Triangle *r)
{
    return 90.0;
}

static void describe(Triangle *r)
{
    printf("[Triangle] area=%.2f scaled=%.2f diag=%.2f side=%.2f side2=%.2f angle=%.2f\n",
           r->fn->area(r),
           r->fn->scaledArea(r),
           r->fn->diagonal(r),
           r->fn->sideArea(r),
           r->fn->sideArea2(r),
           r->fn->rightAngle(r));
}

/* AreaBySideHeight Adapter methods */

static double getHeight(void *r)
{
    return ((Triangle *)r)->h;
}

static double getSide(void *r)
{
    return ((Triangle *)r)->sideLength;
}

Triangle_Fn Triangle_fn;

#define Triangle_PRIVATE_METHODS \
    X(_calculateComplex)         \
    X(_calculateAreaIntense)     \
    X(_calculateAreaAlt)

#define Triangle_PUBLIC_METHODS \
    /* Core geometry */         \
    X(area)                     \
    X(describe)                 \
    X(rightAngle)               \
    X(sideArea)                 \
    X(sideArea2)                \
    X(scaledArea)               \
    X(diagonal)

#define Triangle_IMPLEMENTED_METHODS \
    Triangle_PRIVATE_METHODS         \
    Triangle_PUBLIC_METHODS

/* class prototype */
void Triangle_prototype(void)
{
    INHERIT_METHODS_FROM(Rectangle_fn, Triangle_fn); // auto copy

#define X(name) Triangle_fn.name = name;
    Triangle_IMPLEMENTED_METHODS
#undef X

    Triangle_fn.AreaBySideHeight.getHeight = getHeight;
    Triangle_fn.AreaBySideHeight.getSide = getSide;
}

/* ctor */
Triangle *Triangle_new()
{
    Triangle *r = NEW(Triangle);
    r->fn = &Triangle_fn;

    return r;
}


Filename: Triangle.h
----------------------------------------
#ifndef Triangle_H
#define Triangle_H

#include "module/iam/core/iam.h"
#include "AreaByHeightSide.h"
#include "Rectangle.h"

void Triangle_prototype(void);

__attribute__((constructor)) static void register_Triangle(void)
{
  iam_register(Triangle_prototype);
}

#define Triangle_ONLY_FIELD_LIST \
  X(sideLength, double)

#define Triangle_FIELD_LIST \
  Rectangle_FIELD_LIST      \
  Triangle_ONLY_FIELD_LIST;

#define Triangle_ONLY_METHOD_LIST       \
  METHOD(double, _calculateComplex)     \
  METHOD(double, _calculateAreaIntense) \
  METHOD(double, _calculateAreaAlt)     \
  METHOD(double, rightAngle)            \
  METHOD(double, sideArea)              \
  METHOD(double, sideArea2)

#define Triangle_METHOD_LIST \
  Rectangle_METHOD_LIST      \
  Triangle_ONLY_METHOD_LIST;

/* Child struct */
typedef struct Triangle
{
  struct Triangle_Fn *fn; /* own vtable */
#define X(name, type) type name;
  Triangle_FIELD_LIST
#undef X
} Triangle;

/* Triangle vtable */
typedef struct Triangle_Fn
{
#define METHOD(ret, name, ...) ret (*name)(Triangle *, ##__VA_ARGS__);
  Triangle_METHOD_LIST
#undef METHOD
  AreaBySideHeight_Adapter AreaBySideHeight;
} Triangle_Fn;

extern Triangle_Fn Triangle_fn;

Triangle *Triangle_new();

#endif


