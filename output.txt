Filename: AreaByHeightSide.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include <string.h>

#include "iam.h"
#include "AreaByHeightSide.h"

static double sideArea(void *self, const AreaBySideHeight_Adapter *fn)
{
  return 0.5 * fn->getSide(self) * fn->getHeight(self);
}

static double sideArea2(void *self, const AreaBySideHeight_Adapter *fn)
{
  return AreaBySideHeight_fn.sideArea(self, fn) / 2;
}

AreaBySideHeight_Fn AreaBySideHeight_fn;

/* Mixin initializer */
void AreaBySideHeight_init(void)
{
  AreaBySideHeight_fn.sideArea = sideArea;
  AreaBySideHeight_fn.sideArea2 = sideArea2;
}



Filename: AreaByHeightSide.h
----------------------------------------
#ifndef AREA_BY_SIDE_HEIGHT_H
#define AREA_BY_SIDE_HEIGHT_H

#include "iam.h"

void AreaBySideHeight_init(void);

__attribute__((constructor)) static void register_AreaBySideHeight(void)
{
  iam_register(AreaBySideHeight_init);
}

#define AREA_BY_SIDE_HEIGHT_ADAPTER_METHOD_LIST \
  METHOD(double, getHeight)        \
  METHOD(double, getSide)       

#define AREA_BY_SIDE_HEIGHT_METHOD_LIST \
  METHOD(double, sideArea, const AreaBySideHeight_Adapter *fn)     \
  METHOD(double, sideArea2, const AreaBySideHeight_Adapter *fn)       

/* Child struct */
typedef struct AreaBySideHeight_Adapter
{
#define METHOD(ret, name, ...) ret (*name)(void*, ##__VA_ARGS__);
    AREA_BY_SIDE_HEIGHT_ADAPTER_METHOD_LIST
#undef METHOD
} AreaBySideHeight_Adapter;

/* AreaBySideHeight vtable */
typedef struct AreaBySideHeight_Fn
{
#define METHOD(ret, name, ...) ret (*name)(void*, ##__VA_ARGS__);
    AREA_BY_SIDE_HEIGHT_METHOD_LIST
#undef METHOD
} AreaBySideHeight_Fn;

extern AreaBySideHeight_Fn AreaBySideHeight_fn;

#endif


Filename: iam.c
----------------------------------------
// iam.c
#include "iam.h"

static InitFn registry[2048];
static size_t registry_count = 0;

void iam_register(InitFn fn) {
    registry[registry_count++] = fn;
}

void iam_boot(void) {
    for (size_t i = 0; i < registry_count; i++)
        registry[i]();
}



Filename: iam.h
----------------------------------------
#ifndef IAM_H
#define IAM_H

#include <stdlib.h>

typedef void (*InitFn)(void);

void iam_register(InitFn fn);
void iam_boot(void);

/* Allocate */
#define NEW(T) (T*)malloc(sizeof(T))
    
#define INHERIT_METHODS(child_fn, parent_fn) \
    memcpy(&(child_fn), &(parent_fn), sizeof(parent_fn));

#endif


Filename: main.c
----------------------------------------
#include <stdio.h>

#include "Shape.h"
#include "Rectangle.h"
#include "Triangle.h"

int main()
{
    iam_boot();
    Triangle *t = Triangle_new();
    t->w = 10;
    t->h = 51;
    t->sideLength = 6;
    t->multiplier = 3;

    t->fn->describe(t);
    t->fn->parentMethod(t, 42.0);

    // printf("----\n");
    // Shape *s = Shape_new();
    // s->w = 4;
    // s->h = 3;

    // s->fn->describe(s);

    // printf("----\n");
    // Rectangle *r = Rectangle_new();
    // r->w = 10;
    // r->h = 5;
    // r->multiplier = 5;

    // r->fn->describe(r);
    // printf("[Rectangle] perimeter=%.2f\n", r->fn->perimeter(r));
    // printf("[Rectangle] area=%.2f\n", r->fn->area(r));

    printf("----\n");

    Triangle *t2 = Triangle_new();
    t2->w = 3;
    t2->h = 3;
    t2->sideLength = 6;
    t2->multiplier = 3;

    t2->fn->describe(t2);
    return 0;
}


Filename: Rectangle.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include <string.h>

#include "iam.h"

#include "Shape.h"
#include "Rectangle.h"
/* ---- Implementations ---- */

static double area(Rectangle *r)
{
  printf("[Rectangle.area] called\n");
  double base = Shape_fn.area((Shape*)r);
  printf("[Rectangle.area] base=%.2f\n", base);
  return base * r->multiplier * 3;
}

static double scaledArea(Rectangle *r)
{
  return r->w * r->h * r->multiplier;
}

static double diagonal(Rectangle *r)
{
  return sqrt(r->w * r->w + r->h * r->h);
}

static void describe(Rectangle *r)
{
  printf("[Rectangle] scaled=%.2f diag=%.2f\n",
         scaledArea(r),
         diagonal(r));
}

static void parentMethod(Rectangle *r, double x)
{
    printf("[Rectangle.parentMethod] called with x=%.2f\n", x);
}

Rectangle_Fn Rectangle_fn;

/* class initializer */
void Rectangle_init(void)
{
  INHERIT_METHODS(Rectangle_fn, Shape_fn); // auto copy

  /* overrides */
  Rectangle_fn.area = area;         // override
  Rectangle_fn.describe = describe; // override

  /* child only */
  Rectangle_fn.scaledArea = scaledArea;
  Rectangle_fn.diagonal = diagonal;
  Rectangle_fn.parentMethod = parentMethod;
}

/* ctor */
Rectangle *Rectangle_new()
{
  Rectangle *r = NEW(Rectangle);
  r->fn = &Rectangle_fn;

  return r;
}


Filename: Rectangle.h
----------------------------------------
#ifndef RECTANGLE_H
#define RECTANGLE_H

#include "iam.h"
#include "Shape.h"

void Rectangle_init(void);

__attribute__((constructor)) static void register_Rectangle(void)
{
  iam_register(Rectangle_init);
}

#define RECTANGLE_ONLY_FIELD_LIST \
  X(multiplier, double)
#define RECTANGLE_FIELD_LIST \
  SHAPE_FIELD_LIST           \
  RECTANGLE_ONLY_FIELD_LIST

#define RECTANGLE_ONLY_METHOD_LIST \
  METHOD(double, scaledArea)       \
  METHOD(double, diagonal)         \
  METHOD(void, parentMethod, double)
#define RECTANGLE_METHOD_LIST \
  SHAPE_METHOD_LIST           \
  RECTANGLE_ONLY_METHOD_LIST

typedef struct Rectangle Rectangle;
typedef struct Rectangle_Fn Rectangle_Fn;

/* Child struct */
typedef struct Rectangle
{
  struct Rectangle_Fn *fn; /* own vtable */
#define X(name, type) type name;
  RECTANGLE_FIELD_LIST
#undef X
} Rectangle;

/* Rectangle vtable */
struct Rectangle_Fn
{
#define METHOD(ret, name, ...) ret (*name)(Rectangle*, ##__VA_ARGS__);
    RECTANGLE_METHOD_LIST
#undef METHOD
};

extern Rectangle_Fn Rectangle_fn;

Rectangle *Rectangle_new();

#endif


Filename: Shape.c
----------------------------------------
#include <stdio.h>
#include "Shape.h"

/* ---- implementations ---- */

static double area(Shape *s)
{
  double base = s->w * s->h * 3;
  printf("[Shape.area] w=%.2f h=%.2f base=%.2f\n", s->w, s->h, base);
  return base;
}

static double perimeter(Shape *s)
{
  return 2 * (s->w + s->h);
}

static void describe(Shape *s)
{
  printf("[Shape] w=%.2f h=%.2f area=%.2f\n",
         s->w, s->h, area(s));
}

/* ---- vtable ---- */

Shape_Fn Shape_fn;

/* class initializer */
void Shape_init(void)
{
  Shape_fn.area = area;
  Shape_fn.perimeter = perimeter;
  Shape_fn.describe = describe;
}

/* ---- constructor ---- */

Shape *Shape_new()
{
  Shape *s = NEW(Shape);
  s->fn = &Shape_fn;

  return s;
}


Filename: Shape.h
----------------------------------------
#ifndef SHAPE_H
#define SHAPE_H

#include "iam.h"

void Shape_init(void);

__attribute__((constructor)) static void register_Shape(void)
{
  iam_register(Shape_init);
}

/* X-macro field lists */
#define SHAPE_FIELD_LIST \
  X(w, double)           \
  X(h, double)

/* X-macro method lists */
#define SHAPE_METHOD_LIST   \
  METHOD(double, area)      \
  METHOD(double, perimeter) \
  METHOD(void, describe)

/* Generate struct */
typedef struct Shape
{
  struct Shape_Fn *fn;
/* fields */
#define X(name, type) type name;
  SHAPE_FIELD_LIST
#undef X
} Shape;

/* vtable */
typedef struct Shape_Fn
{
#define METHOD(ret, name, ...) ret (*name)(Shape*, ##__VA_ARGS__);
    SHAPE_METHOD_LIST
#undef METHOD
} Shape_Fn;

extern Shape_Fn Shape_fn;

/* ctor */
Shape *Shape_new();

#endif



Filename: Triangle.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include <string.h>

#include "iam.h"
#include "AreaByHeightSide.h"
#include "Rectangle.h"
#include "Triangle.h"

/* ---- Implementations ---- */

static double area(Triangle *r)
{
    Rectangle_fn.parentMethod((Rectangle *)r, 3.14);
    /* 'super' is stored as void* in the fn table; cast it to Rectangle_Fn* to access area */
    printf("[Triangle.area] called\n");
    double base = Rectangle_fn.area((Rectangle *)r);
    printf("[Triangle.area] base=%.2f\n", base);
    return base * r->multiplier * 2 * r->fn->diagonal(r);
}

static double scaledArea(Triangle *r)
{
    return r->w * r->h * r->multiplier;
}

static double diagonal(Triangle *r)
{
    return sqrt(r->w * r->w + r->h * r->h);
}

static double sideArea(Triangle *r)
{
    return AreaBySideHeight_fn.sideArea(r, &r->fn->AreaBySideHeight);
}

static double sideArea2(Triangle *r)
{
    return AreaBySideHeight_fn.sideArea2(r, &r->fn->AreaBySideHeight);
}

static double rightAngle(Triangle *r)
{
    return 90.0;
}

static void describe(Triangle *r)
{
    printf("[Triangle] area=%.2f scaled=%.2f diag=%.2f side=%.2f side2=%.2f angle=%.2f\n",
           r->fn->area(r),
           r->fn->scaledArea(r),
           r->fn->diagonal(r),
           r->fn->sideArea(r),
           r->fn->sideArea2(r),
           r->fn->rightAngle(r));
}

static double getHeight(Triangle *r)
{
    return r->h;
}

static double getSide(Triangle *r)
{
    return r->sideLength;
}

Triangle_Fn Triangle_fn;

#define TRIANGLE_IMPLEMENTED                \
    /* Core geometry */                     \
    X(area)                                 \
    X(describe)                             \
    X(rightAngle)                           \
    X(sideArea)                             \
    X(sideArea2)                            \
    X(scaledArea)                           \
    X(diagonal)                             \
    /* AreaBySideHeight Adapter contract */ \
    X(getHeight)                            \
    X(getSide)

/* class initializer */
void Triangle_init(void)
{
    INHERIT_METHODS(Triangle_fn, Rectangle_fn); // auto copy

#define X(name) Triangle_fn.name = name;
    TRIANGLE_IMPLEMENTED
#undef X

#define METHOD(returnType, name, ...) \
    Triangle_fn.AreaBySideHeight.name = (void *)name;
    AREA_BY_SIDE_HEIGHT_ADAPTER_METHOD_LIST
#undef METHOD
}

/* ctor */
Triangle *Triangle_new()
{
    Triangle *r = NEW(Triangle);
    r->fn = &Triangle_fn;

    return r;
}


Filename: Triangle.h
----------------------------------------
#ifndef TRIANGLE_H
#define TRIANGLE_H

#include "iam.h"
#include "AreaByHeightSide.h"
#include "Rectangle.h"

void Triangle_init(void);

__attribute__((constructor)) 
static void register_Triangle(void)
{
  iam_register(Triangle_init);
}

#define TRIANGLE_ONLY_FIELD_LIST \
  X(sideLength, double) 

#define TRIANGLE_FIELD_LIST \
  RECTANGLE_FIELD_LIST      \
  TRIANGLE_ONLY_FIELD_LIST;

#define TRIANGLE_ONLY_METHOD_LIST \
  METHOD(double, rightAngle) \
  METHOD(double, sideArea) \
  METHOD(double, sideArea2) \
  METHOD(double, getHeight) \
  METHOD(double, getSide)

#define TRIANGLE_METHOD_LIST \
  RECTANGLE_METHOD_LIST      \
  TRIANGLE_ONLY_METHOD_LIST;

typedef struct Triangle Triangle;
typedef struct Triangle_Fn Triangle_Fn;

/* Child struct */
struct Triangle
{
  struct Triangle_Fn *fn; /* own vtable */
#define X(name, type) type name;
  TRIANGLE_FIELD_LIST
#undef X
};

/* Triangle vtable */
struct Triangle_Fn
{
#define METHOD(ret, name, ...) ret (*name)(Triangle*, ##__VA_ARGS__);
    TRIANGLE_METHOD_LIST
#undef METHOD
  AreaBySideHeight_Adapter AreaBySideHeight;
};

extern Triangle_Fn Triangle_fn;

Triangle *Triangle_new();

#endif


