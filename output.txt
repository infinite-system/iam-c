Filename: iam.h
----------------------------------------
#ifndef IAM_H
#define IAM_H

#include <stdlib.h>

/* Allocate */
#define NEW(T) (T*)malloc(sizeof(T))

/* SUPER(r, area) */
#define SUPER(PARENT, self, METHOD) \
    (((PARENT##_Fn*)PARENT##_fn)->METHOD((void*)(self)))
    
#define INHERIT_METHODS(child_fn, parent_fn) \
    memcpy(&(child_fn), &(parent_fn), sizeof(parent_fn));

#endif-e 


Filename: main.c
----------------------------------------
#include "Shape.h"
#include "Rectangle.h"
#include "Triangle.h"
#include <stdio.h>

int main()
{
    Triangle *t = Triangle_new();
    t->w = 10;
    t->h = 5;
    t->sideLength = 6;
    t->multiplier = 3;

    t->fn->describe(t);
    // Shape *s = Shape_new();
    // s->w = 4;
    // s->h = 3;

    // s->fn->describe(s);

    // Rectangle *r = Rectangle_new();
    // r->w = 10;
    // r->h = 5;
    // r->multiplier = 5;

    // r->fn->describe(r);
    // printf("[Rectangle] perimeter=%.2f\n", r->fn->perimeter(r));
    // printf("[Rectangle] area=%.2f\n", r->fn->area(r));


    return 0;
}-e 


Filename: Rectangle.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include "Shape.h"
#include "Rectangle.h"
#include <string.h>
#include "iam.h"
/* ---- Implementations ---- */

static double area(Rectangle *r)
{
  printf("[Rectangle.area] called\n");
  double base = Shape_fn.area((Shape*)r);
  printf("[Rectangle.area] base=%.2f\n", base);
  return base * r->multiplier * 3;
}

static double scaledArea(Rectangle *r)
{
  return r->w * r->h * r->multiplier;
}

static double diagonal(Rectangle *r)
{
  return sqrt(r->w * r->w + r->h * r->h);
}

static void describe(Rectangle *r)
{
  printf("[Rectangle] scaled=%.2f diag=%.2f\n",
         scaledArea(r),
         diagonal(r));
}

Rectangle_Fn Rectangle_fn;

/* class initializer */
static void Rectangle_init(void)
{
  INHERIT_METHODS(Rectangle_fn, Shape_fn); // auto copy

  Rectangle_fn.super = &Shape_fn;
  /* overrides */
  Rectangle_fn.area = area;         // override
  Rectangle_fn.describe = describe; // override

  /* child only */
  Rectangle_fn.scaledArea = scaledArea;
  Rectangle_fn.diagonal = diagonal;
}

/* auto-run before main */
__attribute__((constructor)) static void Rectangle_auto(void)
{
  Rectangle_init();
}

/* ctor */
Rectangle *Rectangle_new()
{
  Rectangle *r = NEW(Rectangle);
  r->fn = &Rectangle_fn;

  return r;
}-e 


Filename: Rectangle.h
----------------------------------------
#ifndef RECTANGLE_H
#define RECTANGLE_H

#include "Shape.h"

#define RECTANGLE_ONLY_FIELD_LIST \
  X(multiplier, double)
#define RECTANGLE_FIELD_LIST \
  SHAPE_FIELD_LIST           \
  RECTANGLE_ONLY_FIELD_LIST

#define RECTANGLE_ONLY_METHOD_LIST        \
  METHOD(double, scaledArea) \
  METHOD(double, diagonal)
#define RECTANGLE_METHOD_LIST \
  SHAPE_METHOD_LIST           \
  RECTANGLE_ONLY_METHOD_LIST

typedef struct Rectangle Rectangle;
typedef struct Rectangle_Fn Rectangle_Fn;

/* Child struct */
typedef struct Rectangle
{
  struct Rectangle_Fn *fn; /* own vtable */
#define X(name, type) type name;
  RECTANGLE_FIELD_LIST
#undef X
} Rectangle;

/* Rectangle vtable */
struct Rectangle_Fn
{
  void *super; /* placeholder for inheritance */
#define METHOD(ret, name) ret (*name)(Rectangle *);
  RECTANGLE_METHOD_LIST
#undef METHOD
};

extern Rectangle_Fn Rectangle_fn;

Rectangle *Rectangle_new();

#endif-e 


Filename: Shape.c
----------------------------------------
#include <stdio.h>
#include "Shape.h"

/* ---- implementations ---- */

static double area(Shape *s)
{
    double base = s->w * s->h * 3;
    printf("[Shape.area] w=%.2f h=%.2f base=%.2f\n", s->w, s->h, base);
    return base;
}

static double perimeter(Shape *s)
{
    return 2 * (s->w + s->h);
}

static void describe(Shape *s)
{
    printf("[Shape] w=%.2f h=%.2f area=%.2f\n",
           s->w, s->h, area(s));
} 

/* ---- vtable ---- */

Shape_Fn Shape_fn;

/* class initializer */
static void Shape_init(void)
{
    Shape_fn.area      = area;
    Shape_fn.perimeter = perimeter;
    Shape_fn.describe  = describe;
}

/* auto-run BEFORE main() */
__attribute__((constructor))
static void Shape_auto(void) {
    Shape_init();
}


/* ---- constructor ---- */

Shape *Shape_new()
{
    Shape *s = NEW(Shape);
    s->fn = &Shape_fn;

    return s;
}-e 


Filename: Shape.h
----------------------------------------
#ifndef SHAPE_H
#define SHAPE_H

#include "iam.h"

/* X-macro field lists */
#define SHAPE_FIELD_LIST \
  X(w, double)           \
  X(h, double)

/* X-macro method lists */
#define SHAPE_METHOD_LIST            \
  METHOD(double, area)      \
  METHOD(double, perimeter) \
  METHOD(void, describe)

/* Generate struct */
typedef struct Shape
{
  struct Shape_Fn *fn;
  /* fields */
  #define X(name, type) type name;
  SHAPE_FIELD_LIST
  #undef X
} Shape;

/* vtable */
typedef struct Shape_Fn
{
#define METHOD(ret, name) ret (*name)(Shape *);
  SHAPE_METHOD_LIST
#undef METHOD
} Shape_Fn;

extern Shape_Fn Shape_fn;

/* ctor */
Shape *Shape_new();

#endif
-e 


Filename: Triangle.c
----------------------------------------
#include <stdio.h>
#include <math.h>
#include "Triangle.h"
#include "Rectangle.h"
#include <string.h>
#include "iam.h"
/* ---- Implementations ---- */

static double area(Triangle *r)
{
    /* 'super' is stored as void* in the fn table; cast it to Rectangle_Fn* to access area */
    printf("[Triangle.area] called\n");
    double base = Rectangle_fn.area((Rectangle*)r);
    printf("[Triangle.area] base=%.2f\n", base);
    return base * r->multiplier * 1;
}

static double scaledArea(Triangle *r)
{
    return r->w * r->h * r->multiplier;
}

static double diagonal(Triangle *r)
{
    return sqrt(r->w * r->w + r->h * r->h);
}

static double sideArea(Triangle *r)
{
    return 0.5 * r->sideLength * r->h;
}

static double rightAngle(Triangle *r)
{
    return 90.0;
}

static void describe(Triangle *r)
{
    printf("[Triangle] area=%.2f scaled=%.2f diag=%.2f side=%.2f angle=%.2f\n",
           area(r),
           scaledArea(r),
           diagonal(r),
           sideArea(r),
           rightAngle(r));
}

Triangle_Fn Triangle_fn;

/* class initializer */
static void Triangle_init(void)
{
    INHERIT_METHODS(Triangle_fn, Rectangle_fn); // auto copy

    Triangle_fn.super = &Rectangle_fn;
    /* overrides */
    Triangle_fn.area = area;         // override
    Triangle_fn.describe = describe; // override
    Triangle_fn.scaledArea = scaledArea;
    Triangle_fn.diagonal = diagonal;

    /* child only */
    Triangle_fn.sideArea = sideArea;
    Triangle_fn.rightAngle = rightAngle;
}

/* auto-run before main */
__attribute__((constructor)) static void Triangle_auto(void)
{
    Triangle_init();
}

/* ctor */
Triangle *Triangle_new()
{
    Triangle *r = NEW(Triangle);
    r->fn = &Triangle_fn;

    return r;
}-e 


Filename: Triangle.h
----------------------------------------
#ifndef TRIANGLE_H
#define TRIANGLE_H

#include "Rectangle.h"
#include "Shape.h"

#define TRIANGLE_ONLY_FIELD_LIST \
  X(sideLength, double)

#define TRIANGLE_FIELD_LIST \
  RECTANGLE_FIELD_LIST      \
  TRIANGLE_ONLY_FIELD_LIST;

#define TRIANGLE_ONLY_METHOD_LIST      \
  METHOD(double, sideArea) \
  METHOD(double, rightAngle);

#define TRIANGLE_METHOD_LIST \
  RECTANGLE_METHOD_LIST      \
  TRIANGLE_ONLY_METHOD_LIST;

typedef struct Triangle Triangle;
typedef struct Triangle_Fn Triangle_Fn;

/* Child struct */
struct Triangle
{
  struct Triangle_Fn *fn;      /* own vtable */
  #define X(name, type) type name;
  TRIANGLE_FIELD_LIST
  #undef X
};

/* Triangle vtable */
struct Triangle_Fn
{
  void *super;
  #define METHOD(ret, name) ret (*name)(Triangle *);
  TRIANGLE_METHOD_LIST
  #undef METHOD
};

extern Triangle_Fn Triangle_fn;

Triangle *Triangle_new();

#endif-e 


